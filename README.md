# Instructions
1. copy **/public/sw.js** file from public folder into the root directory of your website.   
2. Update your script to load sambha by copy pasting the script from **/public/script.js** to your script file.   

Add checkbox or any ui button to give option for user to subscribe and unsubscribe the notification. we are giving demo with the example of checkbox.   
HTML Code for UI.
``` html
<input class="notify" type="checkbox" onclick="toggleSubscription()" style="display:none"/>
```   

script for checkbox controls.   
```javascript
// store a reference of a chekbox element into a variable named checkbox.
var checkbox = document.querySelector('.notify');

var toggleSubscription = function () {
	if (Gabbar.notificationSettings.isSubscribed) {
		// unsubscribe user if user is already subscribed.
		// code snippet 1.
	} else {
		// subscribe user if user is not subscribed.
		// code snippet 2.
	}
}

```   
replace `code snippet 1` with the following code   
```javascript
Gabbar.notificationSettings.unsubscribe()
.then(function() {
	checkbox.checked = Gabbar.notificationSettings.isSubscribed;
})
.catch(function(error) {
	checkbox.checked = Gabbar.notificationSettings.isSubscribed;
});
```   

replace `code snippet 2` with the following code
```javascript
Gabbar.notificationSettings.subscribe()
.then(function() {
	checkbox.checked = Gabbar.notificationSettings.isSubscribed;
})
.catch(function(error) {
	checkbox.checked = Gabbar.notificationSettings.isSubscribed;
});
```

**Register A Service Worker on load of Gabbar**   
```javascript
Gabbar.onLoad(function() {
	Gabbar.notificationSettings._registerServiceWorker()
	.then(success => {
		checkbox.style.removeProperty('display');
		checkbox.checked = Gabbar.notificationSettings.isSubscribed;
	})
	.catch(error => {
		console.error(error);
	});
});
```   

# Run & Test
To test implemented web notification, service worker needs to be registered which can work only on secure websites having ssl certificate example  `https://example.com`. To test on local get a temporary secure link for your localhost by using ngrok service.

1. download `ngrok` in *home directory*
2. run crm application and web application
3. open a new terminal change path to home directory, run `$ ./ngrok http <crm's port number>`
4. copy the temporary secure link and paste it to *.env file's ngrok variable* and *source for loading script in website* `https://example.ngrok.io/gabbar/js/sambha.js`
5. repeat the step for web app `$ ./ngrok http <web app's port number>`. copy the secure link and open the app via copied link.

**Congratulations you are all set for running and testing web notification. Read the web notification Api given below to better understand the functioning.**

# Web Notification Api
Web  Notification Settings api combined with sambha, via key named __notificationSettings__ can be accessed by `Gabbar.notificationSettings`.

## API
#### PROPERTIES

**`isPushSupported`** _Read only_   
Type: `Boolean` | Default: `false`   
A `Boolean` represeting if Push Notification API is supported on browser or not.

**`isSubscribed`** _Read only_   
Type: `Boolean` |  Default: `false`   
A `Boolean` represeting if user is subscribed or not.

**`_applicationServerPublicKey`**   
Type: `String`   
base 64 URL safe encoded Public key.
Key pair can be generated by this [companion website](https://web-push-codelab.glitch.me/ "Web Push Code Lab Website").

**`_swRegistration`** _Read only_   
Type: `Object` | Default: `null`   
Object containing service worker registration returned at the time of registration of service worker.

#### METHODS
**`permission()`**   
Returns a string representing the current permission to display notifications. Possible values are:   
> **denied** — The user refuses to have notifications displayed.   
> **granted** — The user accepts having notifications displayed.   
> **default** — The user choice is unknown and therefore the browser will act as if the value were denied.   

**`subscribe()`**   
Subscribes to the Push Manager and updates backend.   
``` javascript
notificationSettings.subscribe()
.then(function() {
    // ... 
    // Do things on success in subscribing to push manager. 
    // ...
})
.catch(function(error) {
    // ... 
    // Do things on error in subscribing to push manager. 
    // ...
})
```

**`unsubscribe()`**   
Unsubscribes the subscription from Push Manager and updates backend.   
``` javascript
notificationSettings.unsubscribe()
.then(function() {
    // ... 
    // Do things on success in unsubscribing from push manager. 
    // ...
})
.catch(function(error) {
    // ... 
    // Do things on error in unsubscribing from push manager. 
    // ...
})
```

**`_getSubscription`**   
Returns a promise containing subscription from Push Manager.   

**`_registerServiceWorker`**   
Returns a promise, meanwhile registers a Service Worker and check for subscription if existed or not, send subscription details to backend as an update.   

**`_setIsSubscribed`**   
Returns a promise, meanwhile sets value of `isSubscribed` property, whether user is subscribed or not. called within variuos method to update *isSubscribed* property   

**`_unsubscribe(subscription)`**   
Returns a promise, meanwhile hard unsubscribe the subscription if both anon and registered user choose to unsubscribe from same browser.   

**`_updateBackend(subscription)`**   
Param `subscription`   

| key | value |
| --- | --- |
| endpoint | `String` |
| keys | `Object` |
| permission | `Boolean` |
| isSubscribed | `Boolean` |

Sends Subscription details to backend via `Gabbar.track` with event named `WebNotificationSubscription`

**`_urlB64ToUint8Array(base64String)`**   
Param `base64String`   
we take the application server's public key, which is base 64 URL safe encoded, and we convert it to a UInt8Array as this is the expected input of the subscribe call.   

___
>properties and methods prefixed by **_ underscore** are private apis we highly recommend to not to use private api externally, these are built to serve internal purposes only__
